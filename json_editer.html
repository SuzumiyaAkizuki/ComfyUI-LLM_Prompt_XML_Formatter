<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON ç®€æ˜“ç¼–è¾‘å™¨</title>
    <style>
        :root {
            --primary: #4a90e2;
            --bg: #f4f7f6;
            --panel-bg: #ffffff;
            --border: #ddd;
            --text: #333;
        }
        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; }
        
        /* é¡¶éƒ¨å¯¼èˆª */
        header { background: var(--primary); color: white; padding: 10px 20px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h1 { font-size: 1.2rem; margin: 0; }
        .tips { font-size: 0.8rem; opacity: 0.9; }

        /* ä¸»å¸ƒå±€ */
        .container { display: flex; flex: 1; overflow: hidden; }
        .panel { flex: 1; display: flex; flex-direction: column; padding: 15px; border-right: 1px solid var(--border); overflow: hidden; }
        .panel:last-child { border-right: none; }
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-weight: bold; color: var(--primary); }
        
        /* æŒ‰é’® */
        button { background: var(--primary); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85rem; transition: 0.2s; margin-left: 5px; }
        button:hover { background: #357abd; }
        button.secondary { background: #999; }
        button.secondary:hover { background: #777; }
        button.danger { background: #e74c3c; }
        button.danger:hover { background: #c0392b; }
        
        textarea { flex: 1; width: 100%; border: 1px solid var(--border); border-radius: 4px; padding: 10px; font-family: 'Consolas', monospace; font-size: 0.9rem; resize: none; box-sizing: border-box; }
        textarea:focus { outline: 2px solid var(--primary); border-color: transparent; }

        /* å·¥å…·æ  */
        .toolbar { padding: 5px 0; display: flex; gap: 5px; flex-wrap: wrap; }
        .file-input-wrapper { display: inline-block; position: relative; }
        input[type="file"] { position: absolute; left: 0; top: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }

        /* ç¼–è¾‘å™¨æ ·å¼ */
        #editor-container { flex: 1; overflow-y: auto; border: 1px solid var(--border); background: #fff; padding: 10px; border-radius: 4px; }
        .json-node { margin-left: 20px; padding: 2px 0; font-family: 'Consolas', 'Monaco', monospace; font-size: 0.9rem; border-left: 1px dashed #eee; white-space: nowrap; }
        .json-key { color: #881391; font-weight: bold; cursor: text; margin-right: 5px; }
        
        .json-val { padding: 2px 4px; border: 1px solid transparent; border-radius: 2px; outline: none; }
        .json-val:hover, .json-key:hover { border-color: #ddd; background: #f9f9f9; }
        .json-val:focus, .json-key:focus { border-color: var(--primary); background: #fff; box-shadow: 0 0 3px rgba(74, 144, 226, 0.3); }

        .node-controls { opacity: 0.3; margin-left: 10px; transition: 0.2s; visibility: hidden; }
        .json-node-row:hover .node-controls { opacity: 1; visibility: visible; }
        
        .collapser { cursor: pointer; display: inline-block; width: 12px; text-align: center; color: #555; user-select: none; }
        
        /* åŠ ä¸Š quote æ ·å¼ï¼Œè®©ç”¨æˆ·çŸ¥é“è¿™æ˜¯å­—ç¬¦ä¸² */
        .quote { color: #555; font-weight: normal; user-select: none; }
        
        .type-string { color: #c41a16; }
        .type-number { color: #1c00cf; }
        .type-boolean { color: #0d22aa; }
        .type-null { color: #808080; }
    </style>
</head>
<body>

<header>
    <h1>ğŸ”§ JSON ç®€æ˜“ç¼–è¾‘å™¨</h1>
    <div class="tips"> </div>
</header>

<div class="container">
    <!-- å·¦ä¾§é¢æ¿ -->
    <div class="panel" style="flex: 0.8;">
        <div class="panel-header">ğŸ“ æ–‡æœ¬ <-> JSONå­—ç¬¦ä¸²</div>
        <textarea id="rawText" placeholder="åœ¨æ­¤è¾“å…¥å¤šè¡Œæ–‡æœ¬..."></textarea>
        <div class="toolbar">
            <div class="file-input-wrapper">
                <button class="secondary">ğŸ“‚ å¯¼å…¥æ–‡ä»¶</button>
                <input type="file" onchange="loadFile(this, 'rawText')">
            </div>
            <button onclick="downloadFile('rawText')" class="secondary">ğŸ’¾ ä¸‹è½½</button>
            <div style="flex:1"></div>
            <button onclick="textToJson()">â¬‡ï¸ è½¬ä¸ºJSONä¸²</button>
            <button onclick="jsonToText()">â¬†ï¸ è½¬å›æ–‡æœ¬</button>
        </div>
        <textarea id="jsonString" placeholder='åœ¨æ­¤è¾“å…¥JSONè½¬ä¹‰åçš„å­—ç¬¦ä¸² (ä¾‹å¦‚ "Line1\nLine2")...'></textarea>
        <div class="toolbar">
             <button onclick="copyToClipboard('jsonString')">ğŸ“‘ å¤åˆ¶ç»“æœ</button>
        </div>
    </div>

    <!-- å³ä¾§é¢æ¿ -->
    <div class="panel">
        <div class="panel-header">
            <span>ğŸŒ³ åŸç”Ÿ JSON ç¼–è¾‘å™¨</span>
            <div>
                 <button onclick="resetEditor()">ğŸ†• æ–°å»º</button>
                 <button onclick="syncToView()" class="secondary">ğŸ”„ åˆ·æ–°è§†å›¾</button>
            </div>
        </div>
        <div id="editor-container"></div>
        <div class="toolbar" style="border-top: 1px solid #eee; margin-top: 10px; padding-top: 10px;">
            <div class="file-input-wrapper">
                <button class="secondary">ğŸ“‚ å¯¼å…¥JSON</button>
                <input type="file" onchange="loadJsonFile(this)">
            </div>
            <button onclick="exportJsonFile()" class="secondary">ğŸ’¾ ä¸‹è½½JSON</button>
            <button onclick="copyEditorJson()">ğŸ“‘ å¤åˆ¶JSON</button>
        </div>
    </div>
</div>

<script>
    // --- å·¦ä¾§ æ–‡æœ¬å¤„ç†é€»è¾‘ ---
    function textToJson() {
        const raw = document.getElementById('rawText').value;
        const jsonStr = JSON.stringify(raw);
        document.getElementById('jsonString').value = jsonStr;
    }
    function jsonToText() {
        let jsonStr = document.getElementById('jsonString').value.trim();
        if (!jsonStr) return;
        try {
            const text = JSON.parse(jsonStr);
            if (typeof text !== 'string') {
                alert('è§£æç»“æœä¸æ˜¯çº¯æ–‡æœ¬å­—ç¬¦ä¸²ï¼Œå¯èƒ½æ˜¯å¯¹è±¡æˆ–æ•°ç»„ã€‚');
                return;
            }
            document.getElementById('rawText').value = text;
        } catch (e) {
            alert('JSON è§£æå¤±è´¥ï¼Œè¯·ç¡®ä¿æ ¼å¼æ­£ç¡®ã€‚\n' + e.message);
        }
    }
    function loadFile(input, targetId) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            document.getElementById(targetId).value = e.target.result;
            input.value = '';
        };
        reader.readAsText(file);
    }
    function downloadFile(sourceId) {
        const content = document.getElementById(sourceId).value;
        if (!content) return;
        const blob = new Blob([content], { type: "text/plain" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "result.txt"; a.click();
        URL.revokeObjectURL(url);
    }
    async function copyToClipboard(sourceId) {
        const content = document.getElementById(sourceId).value;
        try { await navigator.clipboard.writeText(content); alert('å¤åˆ¶æˆåŠŸï¼'); } catch (err) {}
    }

    // --- å³ä¾§ JSONç¼–è¾‘å™¨æ ¸å¿ƒé€»è¾‘ ---
    
    let editorData = { 
        "intro": "Line1\nLine2\tTabbed",
        "path": "C:\\Windows\\System32",
        "config": { "debug": true, "timeout": 5000 },
        "list": ["Item 1", "Item 2\nWith Break"]
    };

    const container = document.getElementById('editor-container');

    function renderEditor() {
        container.innerHTML = '';
        container.appendChild(createNode(editorData, 'root', null));
    }

    function createNode(data, key, parent, isArrayItem = false, index = null) {
        const type = data === null ? 'null' : Array.isArray(data) ? 'array' : typeof data;
        
        const row = document.createElement('div');
        row.className = 'json-node-row';
        row.style.display = 'flex';
        row.style.alignItems = 'center';
        
        // 1. æŠ˜å å™¨
        const collapser = document.createElement('span');
        collapser.className = 'collapser';
        if (type === 'object' || type === 'array') {
            collapser.textContent = 'â–¼';
            collapser.onclick = (e) => {
                const children = e.target.closest('.json-node-container').querySelector('.children');
                const isHidden = children.style.display === 'none';
                children.style.display = isHidden ? 'block' : 'none';
                collapser.textContent = isHidden ? 'â–¼' : 'â–¶';
            };
        } else {
            collapser.innerHTML = '&nbsp;';
        }
        row.appendChild(collapser);

        // 2. Key æ˜¾ç¤º
        if (key !== 'root') {
            const keySpan = document.createElement('span');
            keySpan.className = 'json-key';
            keySpan.contentEditable = (key !== 'root' && !isArrayItem);
            keySpan.textContent = isArrayItem ? `[${index}]` : key;
            // æ•°ç»„Keyä¸åŠ å¼•å·ï¼Œå¯¹è±¡Keyè§†è§‰ä¸ŠåŠ ä¸ªå¼•å·æ„Ÿè§‰æ›´åƒFileä½†è¿™é‡Œä¿æŒç®€æ´
            if(!isArrayItem) {
                // keyç¼–è¾‘é€»è¾‘
                keySpan.onblur = function() {
                    const newKey = this.textContent.trim();
                    if (newKey === key || newKey === '') { this.textContent = key; return; }
                    if (parent.hasOwnProperty(newKey)) { alert('Keyå·²å­˜åœ¨'); this.textContent = key; return; }
                    parent[newKey] = parent[key];
                    delete parent[key];
                    renderEditor(); // éœ€è¦å®Œå…¨é‡ç»˜æ¥æ›´æ–°å¼•ç”¨
                };
            }
            row.appendChild(keySpan);
            row.appendChild(document.createTextNode(': '));
        }

        // 3. Value æ˜¾ç¤º (æ ¸å¿ƒä¿®æ”¹ç‚¹)
        if (type === 'object' || type === 'array') {
            const typeSpan = document.createElement('span');
            typeSpan.style.color = '#888';
            typeSpan.style.fontSize = '0.8em';
            typeSpan.textContent = type === 'object' ? '{Object}' : `[Array(${data.length})]`;
            row.appendChild(typeSpan);
        } else {
            // å°†å€¼åŒ…è£¹åœ¨ span é‡Œ
            const valWrapper = document.createElement('span');
            
            // å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼ŒåŠ ä¸Šè§†è§‰ä¸Šçš„å¼•å·
            if (type === 'string') {
                const q1 = document.createElement('span'); q1.className = 'quote'; q1.textContent = '"';
                row.appendChild(q1);
            }

            const valSpan = document.createElement('span');
            valSpan.className = `json-val type-${type}`;
            valSpan.contentEditable = true;

            // --- æ ¸å¿ƒä¿®æ”¹ï¼šä½¿ç”¨ JSON.stringify è·å–åŸå§‹æºç è¡¨ç¤ºï¼Œç„¶åå»æ‰é¦–å°¾å¼•å· ---
            if (type === 'string') {
                // ä¾‹å¦‚: æ•°æ®æ˜¯ "A\nB" (é•¿åº¦3) -> stringify -> "A\\nB" (å¸¦å¼•å·) -> slice -> A\\nB
                let rawString = JSON.stringify(data);
                if (rawString.startsWith('"') && rawString.endsWith('"')) {
                    rawString = rawString.slice(1, -1);
                }
                valSpan.textContent = rawString;
            } else {
                valSpan.textContent = String(data);
            }
            
            // --- æ ¸å¿ƒä¿®æ”¹ï¼šç¼–è¾‘ä¿å­˜é€»è¾‘ ---
            valSpan.onblur = function() {
                let text = this.textContent; // è·å–ç”¨æˆ·è¾“å…¥çš„æ–‡æœ¬ï¼Œä¾‹å¦‚ A\nB
                let newVal;

                if (type === 'string') {
                    try {
                        // è¡¥ä¸Šå¼•å·ï¼Œå°è¯•è¿˜åŸä¸º JavaScript å­—ç¬¦ä¸²
                        // å¦‚æœç”¨æˆ·è¾“å…¥ A\nBï¼Œæ‹¼æ¥æˆ "A\nB"ï¼Œparse åå˜æˆ çœŸå®æ¢è¡Œç¬¦çš„å­—ç¬¦ä¸²
                        newVal = JSON.parse('"' + text + '"');
                    } catch (e) {
                        alert("å­—ç¬¦ä¸²æ ¼å¼é”™è¯¯ï¼\nå¦‚æœæ‚¨æƒ³è¾“å…¥å¼•å·ï¼Œè¯·ä½¿ç”¨ \\\" è½¬ä¹‰ã€‚\nå¦‚æœæ‚¨æƒ³è¾“å…¥åæ–œæ ï¼Œè¯·ä½¿ç”¨ \\\\ã€‚");
                        // è¿˜åŸæ˜¾ç¤º
                        let oldRaw = JSON.stringify(data).slice(1, -1);
                        this.textContent = oldRaw;
                        this.focus();
                        return;
                    }
                } else if (type === 'number') {
                    newVal = Number(text);
                    if (isNaN(newVal)) { alert('è¯·è¾“å…¥æœ‰æ•ˆæ•°å­—'); this.textContent = data; return; }
                } else if (type === 'boolean') {
                    newVal = (text.toLowerCase() === 'true');
                } else if (type === 'null') {
                    newVal = null;
                }

                // æ›´æ–°æ•°æ®
                if (key === 'root') editorData = newVal;
                else if (isArrayItem) parent[index] = newVal;
                else parent[key] = newVal;
                
                // ä¸ºäº†ä¿è¯é¢œè‰²å’Œæ ¼å¼æ­£ç¡®ï¼Œç¨å¾®åˆ·æ–°ä¸€ä¸‹å½“å‰èŠ‚ç‚¹çš„æ ·å¼ï¼ˆå…¶å®stringç±»å‹ä¸éœ€è¦å˜ï¼‰
                // åªæœ‰ç±»å‹å˜äº†æ‰éœ€è¦å¤§åˆ·ï¼Œè¿™é‡Œä¸ºäº†å¯¹é½æ•°æ®ï¼Œç®€å•å¤„ç†
                if(type !== 'string') this.textContent = String(newVal); 
                else {
                    // å¯¹äºstringï¼Œå›æ˜¾ä¿å­˜åçš„ raw æ ¼å¼ (å¤„ç†è‡ªåŠ¨æ¸…ç†å¤šä½™è½¬ä¹‰ç­‰æƒ…å†µ)
                    let savedRaw = JSON.stringify(newVal).slice(1, -1);
                    this.textContent = savedRaw;
                }
            };

            row.appendChild(valSpan);

            if (type === 'string') {
                const q2 = document.createElement('span'); q2.className = 'quote'; q2.textContent = '"';
                row.appendChild(q2);
            }
        }

        // 4. æ“ä½œæŒ‰é’® (+ å’Œ x)
        const controls = document.createElement('span');
        controls.className = 'node-controls';
        
        if (type === 'object' || type === 'array') {
            const addBtn = document.createElement('button');
            addBtn.textContent = '+';
            addBtn.style.padding = '0 5px';
            addBtn.onclick = () => {
                if (type === 'array') data.push("new item");
                else {
                    let k = prompt("æ–° Key:", "key");
                    if (k && !data.hasOwnProperty(k)) data[k] = "value";
                }
                renderEditor();
            };
            controls.appendChild(addBtn);
        }

        if (key !== 'root') {
            const delBtn = document.createElement('button');
            delBtn.className = 'danger';
            delBtn.textContent = 'Ã—';
            delBtn.style.padding = '0 6px';
            delBtn.onclick = () => {
                // ä¸å†å¼¹çª—ç¡®è®¤ï¼ŒåŠ å¿«ç¼–è¾‘é€Ÿåº¦ï¼ŒæŒ‰éœ€å¯æ¢å¤
                if (isArrayItem) parent.splice(index, 1);
                else delete parent[key];
                renderEditor();
            };
            controls.appendChild(delBtn);
        }
        row.appendChild(controls);

        // 5. é€’å½’æ¸²æŸ“å­å®¹å™¨
        const nodeContainer = document.createElement('div');
        nodeContainer.className = 'json-node-container';
        if (key !== 'root') nodeContainer.className += ' json-node';
        nodeContainer.appendChild(row);

        if (type === 'object' || type === 'array') {
            const childrenDiv = document.createElement('div');
            childrenDiv.className = 'children';
            if (type === 'array') {
                data.forEach((item, idx) => {
                    childrenDiv.appendChild(createNode(item, null, data, true, idx));
                });
            } else {
                Object.keys(data).forEach(k => {
                    childrenDiv.appendChild(createNode(data[k], k, data));
                });
            }
            nodeContainer.appendChild(childrenDiv);
        }

        return nodeContainer;
    }

    function resetEditor() { editorData = {}; renderEditor(); }
    function syncToView() { renderEditor(); }

    function loadJsonFile(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                editorData = JSON.parse(e.target.result);
                renderEditor();
            } catch (err) { alert('æ— æ•ˆ JSON'); }
            input.value = '';
        };
        reader.readAsText(file);
    }
    
    function exportJsonFile() {
        const jsonStr = JSON.stringify(editorData, null, 2);
        const blob = new Blob([jsonStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "data.json"; a.click();
        URL.revokeObjectURL(url);
    }

    async function copyEditorJson() {
        try {
            await navigator.clipboard.writeText(JSON.stringify(editorData, null, 2));
            alert('JSON å·²å¤åˆ¶ï¼');
        } catch (err) {}
    }

    renderEditor();
</script>
</body>
</html>
